```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, fig.width=15, fig.height=10)
library(tidyverse)
library(lubridate)
library(googleCloudStorageR)
library(ggplot2)
library(scales)
library(janitor)
library(dataRetrieval)
library(leaflet)
library(readr)
library(ggmap)
library(dataRetrieval)
library(stringr)
library(sf)
library(dplyr)
library(tidyr)

```



```{r}
usgs_list <- read_csv(here::here("data-raw", "USGS_station_lookup.csv")) |>
  janitor::clean_names() |>
  mutate(gage = str_sub(gage,1,8))

get_lat_lon <- function(station_code){
  site_info <- dataRetrieval::readNWISsite(siteNumbers = station_code)
  coordinates <- ifelse(is.null(site_info), list(NA_integer_, NA_integer_), list(site_info$dec_long_va, site_info$dec_lat_va))
  return(coordinates)
}

usgs_result <- dataRetrieval::readNWISsite(siteNumbers = usgs_list$gage)

usgs_list |> 
  left_join(usgs_result, by = join_by(gage == site_no)) |>
  st_as_sf(coords = c("dec_long_va", "dec_lat_va")) |>
  leaflet::leaflet() |> leaflet::addTiles() |> leaflet::addMarkers()

```


```{r}
# Function to fetch flow data for a given site number
fetch_flow_data <- function(site_number) {
  # Specify the parameters for data retrieval
  site <- readNWISsite(site_number)
  parameterCd <- "00060"  # Parameter code for discharge
  service <- "dv"  # Daily values

  # Fetch data
  flow_data <- readNWISdv(siteNumbers = site_number, parameterCd = parameterCd)
  return(flow_data)
}

# Initialize an empty list to store results
flow_years_list <- list()

# Iterate over each site number

for (site_number in usgs_result$site_no) {
  # Fetch flow data
  flow_data <- fetch_flow_data(site_number)
  
  # Extract unique years with flow data
  unique_years <- unique(year(flow_data$dateTime))
  
  # Store the result in the list
  flow_years_list[[as.character(site_number)]] <- unique_years
}

flow_years_df <- data.frame(site_no = character(0), flow_years = integer(0), stringsAsFactors = FALSE)

for (site_number in usgs_result$site_no) {
  # Fetch flow data
  flow_data <- fetch_flow_data(site_number)
  
  # Extract unique years with flow data
  unique_years <- unique(year(flow_data$dateTime))
  
  # If flow data is available, add to flow_years_df
  if (length(unique_years) > 0) {
    flow_years_df <- rbind(flow_years_df, data.frame(site_no = site_number, flow_years = unique_years))
  }
}

# Create a data frame with all years and all site numbers
all_years <- data.frame(site_no = rep(flow_years_df$site_no, each = 100),
                        year = rep(1920:2019, length(unique(flow_years_df$site_no))),
                        stringsAsFactors = FALSE)

# Merge with flow_years_df to mark years with available flow data as TRUE
all_years <- merge(all_years, flow_years_df, by = "site_no", all.x = TRUE)
all_years$flow_years[is.na(all_years$flow_years)] <- 0
all_years$flow_years[all_years$flow_years != 0] <- 1

# Reshape data for plotting
plot_data <- spread(all_years, year, flow_years, fill = NA)

# Plot
ggplot(plot_data, aes(x = year, y = site_no)) +
  geom_tile(aes(fill = as.factor(flow_years)), color = "white") +
  scale_fill_manual(values = c("white", "blue")) +
  labs(x = "Year", y = "Site Number", fill = "Flow Data Available") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


#TODO find a better plot to visualize temporal coverage

```



